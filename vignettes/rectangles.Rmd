---
title: "Vignette Title"
author: "Vignette Author"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, message = FALSE, fig.width = 7, figh.height = 5, fig.show='hold'}
library(gisland)
library(ggplot2)
library(dplyr)
library(tidyr)
library(lubridate)
Station  <- read.csv("http://www.hafro.is/~einarhj/data/tcrenv2016/logbook_station.csv",
                     stringsAsFactors = FALSE) %>%
  tbl_df() %>% 
  mutate(date = ymd(date))

st <- 
  Station %>% 
  mutate(year = year(date),
         sq = rsquare_encode(lon, lat, dx = 0.5, dy = 0.25)) %>%
  filter(year == 2010) %>% 
  group_by(sq) %>% 
  summarise(n = n(),
            effort = sum(towtime, na.rm = TRUE)/(60*24)) %>% 
  separate(sq, c("lon","lat"), sep = ":", convert = TRUE, remove = FALSE)

myqs <-  c(0.001, 0.005,0.1,0.05,0.1,0.25,0.50,0.75,0.90,0.9999)
my_breaks <- as.numeric(exp(quantile(log(st$effort),myqs)))

st %>% 
  ggplot() +
  theme_bw() +
  geom_tile(aes(lon, lat, fill = n)) +
  geom_polygon(data = iceland, aes(long, lat, group = group), fill = "grey90") +
  coord_quickmap() +
  scale_fill_gradient2(low = "white", mid = "yellow", high = "red",
                       midpoint = as.numeric(quantile(st$effort, 0.3)),
                       trans = "log",
                       breaks = my_breaks,
                       labels = my_breaks) +
  scale_x_continuous(NULL, NULL) +
  scale_y_continuous(NULL, NULL)+
  labs(title = "A lat 0.50 by lon 0.25 grid")

st <- 
  Station %>% 
  mutate(year = year(date),
         sq = rsquare_encode(lon, lat, dx = 0.1, dy = 0.05)) %>%
  filter(year == 2010) %>% 
  group_by(sq) %>% 
  summarise(n = n(),
            effort = sum(towtime, na.rm = TRUE)/(60*24)) %>% 
  separate(sq, c("lon","lat"), sep = ":", convert = TRUE, remove = FALSE)

myqs <-  c(0.001, 0.005,0.1,0.05,0.1,0.25,0.50,0.75,0.90,0.9999)
my_breaks <- as.numeric(exp(quantile(log(st$effort),myqs)))

st %>% 
  ggplot() +
  theme_bw() +
  geom_tile(aes(lon, lat, fill = n)) +
  geom_polygon(data = iceland, aes(long, lat, group = group), fill = "grey90") +
  coord_quickmap() +
  scale_fill_gradient2(low = "white", mid = "yellow", high = "red",
                       midpoint = as.numeric(quantile(st$effort, 0.3)),
                       trans = "log",
                       breaks = my_breaks,
                       labels = my_breaks) +
  scale_x_continuous(NULL, NULL) +
  scale_y_continuous(NULL, NULL) +
  labs(title = "A lat 0.1 by lon 0.05 grid")
```